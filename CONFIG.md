# Настройка конфига

Конфиг находится в файле `config.json`. 

Вам нужно создать его самостоятельно. Пример конфига находится в файле `config.example.json`. Копируйте его в файл `config.json` и приступайте к настройке.

Условимся, что `--` перед названием настройки означает, что она отключена. Вообще, бот смотрит только названия известных ему параметров, все остальные он игнорирует.

## Основные параметры бота

Без них бот не заработает.

### bot_token

Токен бота. В телеграме пишите [@botfather](https://t-do.ru/botfather), вводите команду `/newbot`, далее любые имена и в итоге он выдаст токен бота. Его и пишем сюда.

Не забудьте зайти в настройки бота. Разрешить ему группы. И отключить privacy mode.

### database

В базе хранятся имена пользователей, а они любят вставлять туда эмодзи. Для корректного отображения нужно [изменить настройки бд для поддержки utf8mb4](https://mathiasbynens.be/notes/mysql-utf8mb4#character-sets). И перезапустить бд.

Создайте новую базу данных, например `rapturebot` (сравнение выбрать utf8mb4_general_ci). Укажите юзера и пароль для доступа к ней (если пароля нет, то просто удалите его из строки, будет что-то вроде `root:@localhost`).

Создайте таблицы при помощи [rapturebot_empty.sql](https://gist.github.com/pongo/deb687edcbc49962ca8e1e58a4b4bfd4).

### webhook_domain

По-умолчанию этот параметр отключен через `--`. 

Если параметр отключен, то бот будет работать через лонгполлинг. Если параметр включить (убрать `--`) и указать правильный домен, то бот начнет работать через вебхуки. Отмечу, что если в стране заблокирован телеграм, то вебхуки, скорее всего, не заработают.

На сервере домен можно узнать командой:

```console
$ hostname -f
domain.example.com
```

Помимо указания домена, нужно создать самоподписанный сертификат и расположить файлы `private.key` и `cert.pem` рядом с файлом `config.json`.

[Подробнее про вебхуки и создание сертификата](https://github.com/python-telegram-bot/python-telegram-bot/wiki/Webhooks#a-ssl-certificate).

### cache

Параметры работы с редисом. Скорее всего, все заработает со значениями по-умолчанию.

### logging

Параметры логирования. Тоже достаточно стандартных. Можно **level** поменять на `DEBUG` и офигеть.

### telegram_proxy

Если нужно работать через прокси, то включите параметр и укажите нужные значения.

## Параметры чатов

### admins_ids

Админы чата считаются так же админами бота в этом чате. Но можно указать здесь uid людей, которые всегда будут админами бота. Укажите свой. 

Свой userid можно узнать через бота [@userinfobot](https://t-do.ru/userinfobot).

### debug_uid

На этот uid бот будет посылать отладочные сообщения в некоторых случаях. Укажите свой.

### chats

Бот работает только в указанных чатах.

Чтобы узнать id чата: запустите бота, добавьте его в чат, напишите что-нибудь. В логах бота появится строка `Chat -198791234 not in config`. Id этого чата: -198791234. Копируйте в конфиг и настраиваете, какие команды будут работать в этом чате.

Простейший вариант выглядит так:

```json
{
  "chats": {
    "-198791234": {
      "all_cmd": true
    }
  }
}
```

Как видите, у каждого чата есть собственные настройки:

| Параметр чата     | Описание
| :---              | :---
| all_cmd           | Если `true`, то все команды включены, кроме отключенных через `disabled_commands`. <br>Если `false`, то включены будут только указанные в параметре `enabled_commands`. 
| comment           | Пояснение, что это за канал. Ни на что не влияет, просто для удобства.
| enabled_commands  | Список включенных в чате команд. Нужен только если `all_cmd=false`. Список большинства команд находится в файле `commands` в корне проекта. 
| disabled_commands | Список отключенных команд. Нужен только если `all_cmd=true`, но какие-то команды хочется отключить.
| commands_config   | У некоторых команд есть настройки, уникальные для конкретного чата.

Настройки **commands_config**:

| Команда | Настройка | Описание
| :---    | :---      | :---
| time    | sort      | Команда `/time` по-умолчанию сортирует города по времени. Если здесь указать `false`, то они будут отсортированы как в конфиге для команды /`time`. 
| welcome | text      | Когда человека добавляют в чат, то бот напишет этот текст в канал. Через `{username}` можно указать юзернейм новичка.

Скрытые команды для **enabled_commands**:

| Команда               | Описание
| :---                  | :---
| daily_full_moon_check | Если сегодня полнолуние, то в полночь пишет об этом в чат. Для работы требуется указать [ключ](http://api.wunderground.com/) "weather_wunderground_api_key".
| bayanometer           | Включает баянометр для ссылок и картинок.
| welcome               | При добавлении человека в чат будет писать указанный текст. Как настроить текст — см. выше.
| ebalo_zavali          | Пишет ругательство на сообщения типа "доброе утро", "что тут у вас?"
| lord                  | Включает `/lord` — альтернатива `/orzik` для Аляски.
| ask                   | Включает команду `/ask` — магический бот, отвечающий на вопросы.
| weeklystat            | Отправлять ли недельную стату. Отправляется в полночь понедельника по Москве. Сама стата собирается даже если эта команда отключена.
| weeklystat:igorweekly | Отправлять игоря недели.

Эти же команды можно использовать в **disabled_commands**. Дополнительно можно отключить:

| Команда                | Описание
| :---                   | :---
| weeklystat:top_kroshka | Не посылать недельную крошку-картошку.
| weeklystat:pidorweekly | Не посылать пидора недели.


## Параметры команд

### off_delay

Количество секунд, на которое отключаются команды через `/off`. По-умолчанию 5 минут (300 сек).

### top_users_num

Количество строк в команде `/stat`.

### time

Города для команды `/time`. Отображаемое имя и [часовой пояс](http://php.net/manual/ru/timezones.php). По-умолчанию сортируются по времени, но можно отключить сортировку для отдельного чата (см. параметр **chats**).

### weather_wunderground_api_key

Погодный апи ключ [weather wundergroung](http://api.wunderground.com/). Сейчас используется для **daily_full_moon_check**.

### weather_darksky_api_key

Погодый апи ключ [darksky](https://darksky.net/dev). Сейчас не используется, но раньше на нем работала погода.

### weather_yandex_api_key

Погодный апи ключ [яндекс.погоды](https://tech.yandex.ru/weather/), тариф "Погода на вашем сайте". Сейчас используется для показа погоды.

### weather_debug

Если `true`, то вызов `/weather` не обращается к апи, а берет данные из кеша на диске.

### weather_cities

Города для `/weather`.

Формат:

- **Отображаемое имя**.
- **Координаты** — вбивайте название в [яндекс.картах](https://yandex.ru/maps/), в карточке появятся кординаты.
- [**Часовой пояс**](http://php.net/manual/ru/timezones.php).
- **Код города в Weather Undegroung** — сейчас не используется, оставляйте пустым.

### google_vision_client_json_file

Название .json-файла с апи ключом от [google vision api](https://cloud.google.com/vision/). Используется для распознавания котов.

### cat_tag

Если бот нашел на фотке котов, то постит это сообщение.

### leha_ids

Uid Лёхи, нужно для команды `/gdeleha`.

### leha_anya

User id Ани, ведь она тоже Леха. Но перечисляем ее uid отдельно, чтобы не триггерить анус.

### expert_uid

Uid эксперта. Нужно для команды `/expert`.

### orzik

Через запятую перечисляются имена для команды `/orzik`. 

### lord

Через запятую перечисляются имена для команды `/lord`.

### changelog

Текст для команды `/changelog`.

### anecdotica_url

Когда-то там был урл, по которому можно получить новый анекдот. Но это криво работало. Нужно использовать [ключ апи](http://anecdotica.ru/) и генерировать новый урл при каждом запросе.

### dialogflow_api_token

Апи [dialogflow](https://dialogflow.com/) — через него бот отвечает на сообщения в личке (он очень тупой).

### anon_chat_id

В этот чат отправляются анонимки. 

### sasha_rebinder_stickersets_names

Любимые стикерпаки. Они могут выпасть из `/pipinder`, даже если они уже были.

### repinder_users

Кто может использовать `/repinder`.

### replylove__dragon_lovers

В страсти они поклоняются дракону. Просто uid.

### replylove__ignore

Не учитываются в страсти.

### replylove__narcissist

Нарциссы в страсти.

### replylove__ignore_pairs

Парная страсть игнорируется. Например, для группы `-1` мы полностью игнорируем любую парную страсть пользователей `1` и `2`.

```json
{
  "replylove__ignore_pairs": {
      "-1": {
        "1": [2],
        "2": [1]
      }
    },
}
```

### pm2_bot_repair

Этот скрипт запускается, если бот решил, что он сломался и ему нужно себя перезапустить.

### pm2_repair

Это на случай если сам PM2 сломался и его нужно перезапустить. ["Веселая" история](https://t.me/rapture_dev_blog/26).

### mat_notify_uids

Если эти пользователи матерятся, то бот стыдит их.

### matshowtime → channel_id

Id канала с матами. Бот должен быть там админом.

### ktolivnul

Id КтоЛивнулыча. Необходимо для работы `/leave`.

### ducks_trigger

Если кто-то из чата `anon_chat_id` написал слово, проходящее регулярное выражение `re_pattern`, то бот через несколько часов запостит сообщение, состоящее из повторов случайного значения `variants`. Количество повторов будет увеличено на единицу. При этом это количество начнет храниться в редисе 1-7 дней (выбирается случайно). Если за это время никто не напишет триггер, то количество сбрасывается.
